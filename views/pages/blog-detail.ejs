<%- include('../partials/head') %> <%- include('../partials/nav') %>

<section class="container">
  <article class="card">
    <div class="image">
       <% if (blog.image) { %>
      <img src="<%= blog.image %>" alt="<%= blog.title %>" />
    <% } %>
    </div>

    <div class="card_body">
      <h1 class="card_title"><%= blog.title %></h1>
      <p><em><%= blog.author %></em></p>
      
      <!-- Blog datos -->
      <% if (blog.createdAt) { %>
        <p class="blog-meta">
          ğŸ“… Paskelbta: <%= new Date(blog.createdAt).toLocaleDateString('lt-LT') %>
        </p>
      <% } %>
      
      <!-- Blog turinys -->
      <div class="blog-content">
        <%- (blog.body || blog.content).replace(/\n/g, '<br>') %>
      </div>
      
      <!-- Blog veiksmai -->
      <div class="blog-actions">
        <a href="/blog" class="btn btn-back">â† Atgal Ä¯ sÄ…raÅ¡Ä…</a>
        <% if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'admin') { %>
          <a href="/blog/<%= blogId %>/edit" class="btn btn-edit">âœï¸ Redaguoti</a>
          <button onclick="deleteBlog('<%= blogId %>')" class="btn btn-delete">
            ğŸ—‘ï¸ IÅ¡trinti Ä®raÅ¡Ä…
          </button>
        <% } %>
      </div>
    </div>
  </article>
  
  <!-- KomentarÅ³ sekcija -->
  <section class="comments-section">
    <h2>Komentarai</h2>

    <!-- KomentarÅ³ forma -->
    <div class="comment-form-container">
      <h3>Palikti komentarÄ…</h3>
      <form id="commentForm" class="comment-form">
        <div class="form-group">
          <label for="author">JÅ«sÅ³ vardas:</label>
          <input type="text" id="author" name="authorName" required minlength="2" placeholder="Ä®veskite savo vardÄ…">
        </div>

        <div class="form-group">
          <label for="content">Komentaras:</label>
          <textarea id="content" name="commentContent" rows="4" required minlength="5" placeholder="Pasidalinkite savo mintimis..."></textarea>
        </div>

        <button type="submit" class="submit-btn">Skelbti komentarÄ…</button>
      </form>
    </div>

    <!-- KomentarÅ³ sÄ…raÅ¡as -->
    <div id="commentsList" class="comments-list">
      <!-- Komentarai bus Ä¯kelti Äia -->
    </div>
  </section>
</section>

<script>
  // KomentarÅ³ funkcionalumas
  class CommentSystem {
    constructor(blogPostId) {
      this.blogPostId = blogPostId;
      this.init();
    }

    init() {
      this.loadComments();
      this.setupForm();
    }

    setupForm() {
      const form = document.getElementById('commentForm');
      form.addEventListener('submit', (event) => this.handleSubmit(event));
    }

    async loadComments() {
      try {
        const response = await fetch(`/api/blog/${this.blogPostId}/comments`);
        const data = await response.json();

        if (data.success) {
          this.displayComments(data.blogComments);
        }
      } catch (error) {
        console.error('Klaida Ä¯keliant komentarus:', error);
      }
    }

    async handleSubmit(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const commentData = {
        authorName: formData.get('authorName'),
        commentContent: formData.get('commentContent')
      };

      try {
        const response = await fetch(`/api/blog/${this.blogPostId}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(commentData)
        });

        const data = await response.json();

        if (data.success) {
          event.target.reset();
          this.loadComments(); // Perkrauti komentarus
          this.showMessage('Komentaras sÄ—kmingai paskelbtas!', 'success');
        } else {
          this.showMessage(data.message, 'error');
        }
      } catch (error) {
        console.error('Klaida siunÄiant komentarÄ…:', error);
        this.showMessage('Klaida siunÄiant komentarÄ…. Bandykite dar kartÄ….', 'error');
      }
    }

    displayComments(blogComments) {
      const container = document.getElementById('commentsList');

      // Jei tuÅ¡Äias
      if (blogComments.length === 0) {
        container.innerHTML = '<p class="no-comments">Dar nÄ—ra komentarÅ³. BÅ«kite pirmas!</p>';
        return;
      }

      // VARIANTAS SU forEach (vietoj map)
      let html = '';  // â† Pradinis tuÅ¡Äias string
      
      blogComments.forEach(comment => {
        // Pradedame komentaro HTML
        html += `<div class="comment">`;
        
        // Header su autoriumi ir data
        html += `
          <div class="comment-header">
            <strong class="comment-author">${this.escapeHtml(comment.authorName)}</strong>
            <span class="comment-date">${this.formatDate(comment.createdAtDate)}</span>
          </div>
        `;
        
        // Komentaro turinys
        html += `
          <div class="comment-content">
            ${this.escapeHtml(comment.commentContent)}
          </div>
        `;

        // Veiksmai su komentarais (redaguoti / trinti)
        html += `
          <div class="comment-actions" style="margin-top:8px; display:flex; gap:8px;">
            <button type="button" class="btn btn-edit btn-sm edit-comment" data-comment-id="${comment._id}">âœï¸ Redaguoti</button>
            <button type="button" class="btn btn-delete btn-sm delete-comment" data-comment-id="${comment._id}">ğŸ—‘ï¸ Trinti</button>
          </div>
        `;
        
        // REPLIES (atsakymai) - jei yra
        if (comment.replies && comment.replies.length > 0) {
          html += `<div class="replies">`;
          html += `<h4 class="replies-title">Atsakymai (${comment.replies.length})</h4>`;
          
          // forEach per replies
          comment.replies.forEach(reply => {
            html += `
              <div class="reply">
                <div>
                  <strong>${this.escapeHtml(reply.authorName)}</strong>
                  <span>${this.formatDate(reply.createdAtDate)}</span>
                </div>
                <div>
                  ${this.escapeHtml(reply.replyContent)}
                </div>
              </div>
            `;
          });
          
          html += `</div>`; // UÅ¾daryti replies div
        }
        
        // Atsakymo forma kiekvienam komentarui (paslÄ—pta pagal nutylÄ—jimÄ…)
        html += `
          <div class="reply-box">
            <button type="button" class="toggle-reply" data-comment-id="${comment._id}" aria-expanded="false">â†©ï¸ Atsakyti Ä¯ Å¡Ä¯ komentarÄ…</button>
            <form class="reply-form" data-comment-id="${comment._id}" style="display:none; margin-top:8px;">
              <div class="form-group">
                <label>JÅ«sÅ³ vardas</label>
                <input type="text" name="authorName" required minlength="2" placeholder="Pvz.: Jonas" />
              </div>
              <div class="form-group">
                <label>JÅ«sÅ³ atsakymas</label>
                <textarea name="replyContent" rows="2" required minlength="2" placeholder="ParaÅ¡ykite atsakymÄ…..."></textarea>
              </div>
              <button type="submit" class="submit-reply-btn">Paskelbti atsakymÄ…</button>
            </form>
          </div>
        `;

        html += `</div>`; // UÅ¾daryti comment div
      });
      
      // Ä®dÄ—ti sugeneruotÄ… HTML Ä¯ konteinerÄ¯
      container.innerHTML = html;

      // PririÅ¡ti "Atsakyti" mygtukÅ³ toggle
      document.querySelectorAll('.toggle-reply').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-comment-id');
          const form = document.querySelector(`form.reply-form[data-comment-id="${id}"]`);
          const isHidden = form.style.display === 'none';
          form.style.display = isHidden ? 'block' : 'none';
          btn.setAttribute('aria-expanded', String(isHidden));
        });
      });

      // PririÅ¡ti atsakymo formÅ³ submit Ä¯vykius
      document.querySelectorAll('.reply-form').forEach(form => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const commentId = form.getAttribute('data-comment-id');
          const formData = new FormData(form);
          const payload = {
            authorName: formData.get('authorName'),
            replyContent: formData.get('replyContent')
          };

          try {
            const resp = await fetch(`/api/blog/${this.blogPostId}/comments/${commentId}/replies`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await resp.json();
            if (data.success) {
              form.reset();
              form.style.display = 'none';
              this.loadComments();
              this.showMessage('Atsakymas sÄ—kmingai pridÄ—tas!', 'success');
            } else {
              this.showMessage(data.message || 'Nepavyko pridÄ—ti atsakymo', 'error');
            }
          } catch (err) {
            console.error('Klaida siunÄiant atsakymÄ…:', err);
            this.showMessage('Klaida siunÄiant atsakymÄ…. Bandykite dar kartÄ….', 'error');
          }
        });
      });

      // PririÅ¡ti REDAGUOTI komentarÄ…
      document.querySelectorAll('.edit-comment').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-comment-id');
          this.enterEditModeForComment(id);
        });
      });

      // PririÅ¡ti TRINTI komentarÄ…
      document.querySelectorAll('.delete-comment').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-comment-id');
          const confirmed = confirm('Ar tikrai norite iÅ¡trinti Å¡Ä¯ komentarÄ…?');
          if (!confirmed) return;
          try {
            const resp = await fetch(`/api/blog/${this.blogPostId}/comments/${id}`, { method: 'DELETE' });
            const data = await resp.json();
            if (data.success) {
              this.loadComments();
              this.showMessage('Komentaras sÄ—kmingai iÅ¡trintas!', 'success');
            } else {
              this.showMessage(data.message || 'Nepavyko iÅ¡trinti komentaro', 'error');
            }
          } catch (err) {
            console.error('Klaida trinant komentarÄ…:', err);
            this.showMessage('Klaida trinant komentarÄ…. Bandykite dar kartÄ….', 'error');
          }
        });
      });
    }

    formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('lt-LT') + ' ' + date.toLocaleTimeString('lt-LT', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    showMessage(message, type) {
      // PaÅ¡alinti esamÄ… praneÅ¡imÄ…
      const existingMessage = document.querySelector('.message');
      if (existingMessage) {
        existingMessage.remove();
      }

      // Sukurti naujÄ… praneÅ¡imÄ…
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${type}`;
      messageDiv.textContent = message;

      // Ä®terpti po forma
      const form = document.getElementById('commentForm');
      form.parentNode.insertBefore(messageDiv, form.nextSibling);

      // PaÅ¡alinti praneÅ¡imÄ… po 5 sekundÅ¾iÅ³
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }
  }

  // Inicializuoti komentarÅ³ sistemÄ…, kai puslapis uÅ¾sikrauna
  document.addEventListener('DOMContentLoaded', function() {
    // Gauti blog ID iÅ¡ serverio perduoto kintamojo
    const blogPostId = '<%= blogId %>';

    if (blogPostId) {
      new CommentSystem(blogPostId);
    }
  });

  /**
   * Blog Delete Funkcija
   * 
   * Kaip veikia:
   * 1. Vartotojas paspaudÅ¾ia "IÅ¡trinti" mygtukÄ…
   * 2. IÅ¡Å¡aukiama Å¡i funkcija su blog ID
   * 3. Patvirtinimo dialogas (confirm)
   * 4. Fetch DELETE uÅ¾klausa Ä¯ serverÄ¯
   * 5. Serveris iÅ¡trina iÅ¡ blogs.json
   * 6. Redirect Ä¯ blog sÄ…raÅ¡Ä…
   */
  async function deleteBlog(blogId) {
    // Å½INGSNIS 0: Patikrinti ar Ä¯raÅ¡as egzistuoja
    try {
      const existsResp = await fetch(`/blog/${blogId}/exists`);
      const existsData = await existsResp.json();
      if (!existsData.success || !existsData.exists) {
        alert('âŒ Ä®raÅ¡as nerastas arba jau iÅ¡trintas.');
        window.location.href = '/blog';
        return;
      }
    } catch (e) {
      console.error('Klaida tikrinant egzistavimÄ…:', e);
      alert('âŒ Nepavyko patikrinti Ä¯raÅ¡o egzistavimo.');
      return;
    }

    // Å½INGSNIS 1: Patvirtinimas
    const confirmed = confirm('Ar tikrai norite iÅ¡trinti Å¡Ä¯ blog Ä¯raÅ¡Ä…? Å is veiksmas neatÅ¡aukiamas!');
    if (!confirmed) return;
    
    try {
      // Å½INGSNIS 2: SiÅ³sti DELETE uÅ¾klausÄ…
      const response = await fetch(`/blog/${blogId}`, {
        method: 'DELETE', // DELETE metodas (ne GET, ne POST)
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      // Å½INGSNIS 3: Parsinti atsakymÄ…
      const data = await response.json();
      
      // Å½INGSNIS 4: Tikrinti ar sÄ—kminga
      if (data.success) {
        // Rodyti praneÅ¡imÄ…
        alert('âœ… Blog Ä¯raÅ¡as sÄ—kmingai iÅ¡trintas!');
        
        // Redirect Ä¯ blog sÄ…raÅ¡Ä…
        window.location.href = data.redirectUrl || '/blog';
        
      } else {
        // Klaida iÅ¡ serverio
        alert('âŒ Klaida: ' + data.message);
      }
      
    } catch (error) {
      // Network klaida arba serveris neveikia
      console.error('Klaida trinant blog:', error);
      alert('âŒ Nepavyko iÅ¡trinti blog Ä¯raÅ¡o. Patikrinkite interneto ryÅ¡Ä¯.');
    }
  }
</script>

<%- include('../partials/footer') %>
